<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STA城哨</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/map.css">
    <link rel="stylesheet" href="css/report.css">
    <link rel="stylesheet" href="css/monitoring.css">
    
    <!-- 使用稳定版本的高德地图API -->
    <script src="https://webapi.amap.com/maps?v=1.4.15&key=38299c26529e4031094d29c54afddb79"></script>
</head>
<body>
    <header class="main-header">
        <div class="header-container">
            <div class="logo-container">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 1L3 5V11C3 16.55 6.84 21.74 12 23C17.16 21.74 21 16.55 21 11V5L12 1Z" fill="#0066cc" stroke="#ffffff" stroke-width="2"/>
                        <path d="M12 7V13" stroke="#ffffff" stroke-width="2" stroke-linecap="round"/>
                        <circle cx="12" cy="16" r="1" fill="#ffffff"/>
                    </svg>
                </div>
                <h1>STA城哨</h1>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li><a href="#" class="nav-link active" data-page="real-time">实时地图</a></li>
                    <li><a href="#" class="nav-link" data-page="history">历史地图</a></li>
                    <li><a href="#" class="nav-link" data-page="report">日报系统</a></li>
                    <li><a href="#" class="nav-link" data-page="monitoring">监控系统</a></li>
                </ul>
            </nav>
            <div class="user-info">
                <div class="user-avatar">管理员</div>
            </div>
        </div>
    </header>

    <main>
        <!-- 实时地图页面 -->
        <section id="real-time-page" class="page active">
            <div id="map-container"></div>
            
            <!-- 全局提醒 -->
            <div class="global-alert">
                <div class="alert-icon"></div>
                <div class="alert-message" id="latest-event-alert">
                    正在加载最新事件...
                </div>
            </div>
            
            <div class="event-legend">
                <div class="legend-item"><span class="dot red"></span>极敏感事件</div>
                <div class="legend-item"><span class="dot orange"></span>敏感事件</div>
                <div class="legend-item"><span class="dot yellow"></span>关注事件</div>
                <div class="legend-item"><span class="dot blue"></span>普通事件</div>
                <div class="legend-item"><span class="dot green"></span>已处理事件</div>
            </div>
            
            <!-- 右侧功能面板 -->
            <div class="right-panel">
                <!-- 事件预警面板，简化内容 -->
                <div class="panel-section">
                    <h3>事件预警统计</h3>
                    <div id="event-summary" class="event-summary-container">
                        <!-- 事件类型统计将通过JS动态加载 -->
                    </div>
                </div>
                
                <!-- 区域安全面板 -->
                <div class="panel-section">
                    <h3>区域安全指数</h3>
                    <div id="safety-index">
                        <!-- 区域安全指数将通过JS动态加载 -->
                    </div>
                </div>
            </div>
        </section>

        <!-- 历史地图页面 -->
        <section id="history-page" class="page">
            <div id="history-map-container" style="width: 100%; height: 100vh; position: absolute; top: 0; left: 0; z-index: 5;"></div>
            
            <!-- 日期选择器 - 修改类名 -->
            <div class="date-selector-panel">
                <h3>历史事件查询</h3>
                <div class="calendar">
                    <div class="calendar-header">2025年5月</div>
                    <div class="calendar-grid">
                        <div class="calendar-day day-header">日</div>
                        <div class="calendar-day day-header">一</div>
                        <div class="calendar-day day-header">二</div>
                        <div class="calendar-day day-header">三</div>
                        <div class="calendar-day day-header">四</div>
                        <div class="calendar-day day-header">五</div>
                        <div class="calendar-day day-header">六</div>

                        <!-- 4月日期 - 修改类名 -->
                        <div class="calendar-day day-clickable day-looks-selectable">27</div>
                        <div class="calendar-day day-clickable day-looks-selectable">28</div>
                        <div class="calendar-day day-clickable day-looks-selectable">29</div>
                        <div class="calendar-day day-clickable day-looks-selectable">30</div>

                        <!-- 5月1-2日 - 修改类名 -->
                        <div class="calendar-day day-clickable day-looks-selectable">1</div>
                        <div class="calendar-day day-clickable day-looks-selectable">2</div>
                        <!-- 5月3-4日 - 保留类名 -->
                        <div class="calendar-day day-clickable day-selectable" data-date="2025-05-03">3</div>
                        <div class="calendar-day day-clickable day-selectable active" data-date="2025-05-04">4</div>

                        <!-- 5月5日及以后 -->
                        <div class="calendar-day day-disabled">5</div>
                        <div class="calendar-day day-disabled">6</div>
                        <!-- ... other disabled days ... -->
                         <div class="calendar-day day-disabled">7</div>
                         <div class="calendar-day day-disabled">8</div>
                         <div class="calendar-day day-disabled">9</div>
                         <div class="calendar-day day-disabled">10</div>
                         <div class="calendar-day day-disabled">11</div>
                         <div class="calendar-day day-disabled">12</div>
                         <div class="calendar-day day-disabled">13</div>
                         <div class="calendar-day day-disabled">14</div>
                         <div class="calendar-day day-disabled">15</div>
                         <div class="calendar-day day-disabled">16</div>
                         <div class="calendar-day day-disabled">17</div>
                         <div class="calendar-day day-disabled">18</div>
                         <div class="calendar-day day-disabled">19</div>
                         <div class="calendar-day day-disabled">20</div>
                         <div class="calendar-day day-disabled">21</div>
                         <div class="calendar-day day-disabled">22</div>
                         <div class="calendar-day day-disabled">23</div>
                         <div class="calendar-day day-disabled">24</div>
                    </div>
                </div>
            </div>
            
            <div class="event-legend">
                <div class="legend-item"><span class="dot red"></span>极敏感事件</div>
                <div class="legend-item"><span class="dot orange"></span>敏感事件</div>
                <div class="legend-item"><span class="dot yellow"></span>关注事件</div>
                <div class="legend-item"><span class="dot blue"></span>普通事件</div>
                <div class="legend-item"><span class="dot green"></span>已处理事件</div>
            </div>
            
            <!-- 右侧功能面板 -->
            <div class="right-panel">
                <!-- 事件统计面板 -->
                <div class="panel-section">
                    <h3>历史事件统计</h3>
                    <!-- 修改: 容器 ID 不变，内容将由 JS 生成新卡片布局 -->
                    <div id="history-summary" class="event-summary-container">
                        <!-- 内容由 JS 填充 -->
                    </div>
                </div>
                
                <!-- 区域统计面板 -->
                <div class="panel-section">
                    <h3>区域安全指数</h3>
                    <div id="history-safety-index">
                        <!-- 内容由 JS 填充，包含 .safety-grid -->
                    </div>
                </div>
            </div>
        </section>

        <!-- 修改日报系统页面 -->
        <section id="report-page" class="page">
            <div class="report-header">
                <h2>系统月度报告</h2>
                <div class="report-date">2025年5月</div>
            </div>
            
            <!-- 上面一行的三个框 -->
            <div class="report-row">
                <!-- 本月事件统计 -->
                <div class="report-card">
                    <h3>本月事件统计</h3>
                    <div id="monthly-events-chart" class="chart-container"></div>
                </div>
                
                <!-- 区域安全指数 -->
                <div class="report-card">
                    <h3>区域安全指数</h3>
                    <div id="area-safety-chart" class="chart-container"></div>
                </div>
                
                <!-- 实时预警信息 -->
                <div class="report-card">
                    <h3>实时预警信息</h3>
                    <div class="alert-list">
                        <div class="alert-item">
                            <div class="alert-time">5月5日 21:34</div>
                            <div class="alert-content">洪山区发生敏感事件：火警警报</div>
            </div>
                        <div class="alert-item">
                            <div class="alert-time">5月4日 23:12</div>
                            <div class="alert-content">江岸区发生关注事件：尖叫声</div>
                </div>
                        <div class="alert-item">
                            <div class="alert-time">5月2日 20:45</div>
                            <div class="alert-content">武昌区发生极敏感事件：爆炸声</div>
                </div>
                </div>
                </div>
            </div>
            
            <!-- 下面一行的两个框 -->
            <div class="report-row">
                <!-- 年度事件趋势 -->
                <div class="report-card large">
                    <h3>年度事件趋势</h3>
                    <div id="yearly-trend-chart" class="chart-container"></div>
                </div>
                
                <!-- 本月重要事件 -->
                <div class="report-card">
                    <h3>本月重要事件</h3>
                    <div class="important-events">
                        <div class="event-item">
                            <div class="event-time">5月5日</div>
                            <div class="event-content">洪山区检测到火警警报，安保人员已到场处理</div>
                        </div>
                        <div class="event-item">
                            <div class="event-time">5月2日</div>
                            <div class="event-content">武昌区检测到爆炸声，已通知警方处理</div>
                </div>
                        <div class="event-item">
                            <div class="event-time">5月1日</div>
                            <div class="event-content">青山区检测到枪声，警方已介入调查</div>
                </div>
                </div>
            </div>
            </div>
        </section>

        <!-- 监控系统页面 -->
        <section id="monitoring-page" class="page">
            <div class="monitoring-container">
                <!-- 左侧视频播放区域 -->
                <div class="video-player-area">
                    <div class="video-player">
                        <div class="no-video-message" id="no-video-message">
                            请点击右侧导入按钮播放监控画面
                        </div>
                        <video id="monitoring-video" style="display: none;" controls>
                            <source src="" type="video/mp4">
                            您的浏览器不支持 HTML5 视频。
                        </video>
                        <div class="video-controls">
                            <button class="control-button" id="play-pause-btn">▶ 播放</button>
                            <button class="control-button" id="fullscreen-btn">⛶ 全屏</button>
                        </div>
                    </div>
                </div>
                
                <!-- 右侧监控控制区域 -->
                <div class="camera-list-area">
                    <div class="camera-list-header">
                        <h3>监控控制面板</h3>
                    </div>
                    <div class="camera-control-panel">
                        <div class="preset-camera">
                            <div class="camera-icon"></div>
                            <div class="camera-details">
                                <div class="camera-title">东西湖区 - 惠安大道</div>
                                <div class="camera-location">惠安大道与吴家山交叉口</div>
                            </div>
                            <div class="camera-status status-online"></div>
                        </div>
                        
                        <div class="camera-actions">
                            <button id="import-video-btn" class="action-button">导入监控视频</button>
                            <div class="camera-selector">
                                <button class="selector-button active">东西湖区监控</button>
                                <button class="selector-button">江汉区监控</button>
                                <button class="selector-button">武昌区监控</button>
                            </div>
                        </div>
                        
                        <div class="camera-info">
                            <h4>监控信息</h4>
                            <div class="info-item">
                                <span class="info-label">设备类型：</span>
                                <span class="info-value">高清摄像头</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">分辨率：</span>
                                <span class="info-value">1080P</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">帧率：</span>
                                <span class="info-value">30fps</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">安装日期：</span>
                                <span class="info-value">2025年3月15日</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">上次维护：</span>
                                <span class="info-value">2025年4月28日</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- 事件详情模态窗口 -->
    <div id="event-detail-modal">
        <div class="modal-content">
            <span id="modal-close" class="modal-close">&times;</span>
            <h2 id="modal-title">事件详情</h2>
            <div class="modal-grid">
                <!-- 左侧：事件概率详情 -->
                <div class="modal-left">
                    <h3>事件识别概率</h3>
                    <div id="event-probabilities" style="margin-bottom: 20px;"></div>
                    
                    <h3>事件信息</h3>
                    <table>
                        <tr>
                            <td>事件类型:</td>
                            <td id="modal-event-type"></td>
                        </tr>
                        <tr>
                            <td>事件级别:</td>
                            <td id="modal-event-level"></td>
                        </tr>
                        <tr>
                            <td>事件位置:</td>
                            <td id="modal-event-location"></td>
                        </tr>
                        <tr>
                            <td>详细说明:</td>
                            <td id="modal-event-desc"></td>
                        </tr>
                    </table>
                </div>
                
                <!-- 右侧：实时监控 -->
                <div class="modal-right">
                    <h3>实时监控画面</h3>
                    <div class="modal-video-container">
                        <video id="modal-monitoring-video" autoplay loop controls>
                            <source src="images/test1.mp4" type="video/mp4">
                            您的浏览器不支持视频播放
                        </video>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    </style>

    <script>
    // 确保页面加载完成后执行
    document.addEventListener('DOMContentLoaded', function() {
        // 显示模态窗口的函数
        window.showEventModal = function(event) {
            console.log("显示事件详情:", event);
            
            // 设置模态窗口内容
            document.getElementById('modal-title').textContent = event.type;
            document.getElementById('modal-event-type').textContent = event.type;
            document.getElementById('modal-event-level').textContent = getLevelName(event.level);
            document.getElementById('modal-event-location').textContent = '武汉市 洪山区'; // 修改为洪山区
            document.getElementById('modal-event-desc').textContent = event.description;
            
            // 生成概率条
            const probContainer = document.getElementById('event-probabilities');
            probContainer.innerHTML = '';
            
            // 根据事件类型设置更具体的相似事件
            let similarEvents = [];
            switch(event.type) {
                case '爆炸声音':
                    similarEvents = [
                        { type: '撞击声', prob: 0.10 },
                        { type: '建筑倒塌声', prob: 0.05 }
                    ];
                    break;
                case '枪声':
                    similarEvents = [
                        { type: '爆炸声音', prob: 0.08 },
                        { type: '金属撞击声', prob: 0.07 }
                    ];
                    break;
                case '火警警报':
                    similarEvents = [
                        { type: '烟雾报警器', prob: 0.09 },
                        { type: '警笛声', prob: 0.06 }
                    ];
                    break;
                case '烟雾报警器':
                    similarEvents = [
                        { type: '火警警报', prob: 0.12 },
                        { type: '高分贝噪音', prob: 0.03 }
                    ];
                    break;
                case '汽车报警器':
                    similarEvents = [
                        { type: '警笛声', prob: 0.11 },
                        { type: '火警警报', prob: 0.04 }
                    ];
                    break;
                default:
                    similarEvents = [
                        { type: '机械声', prob: 0.09 },
                        { type: '高分贝噪音', prob: 0.06 }
                    ];
            }
            
            // 示例概率数据
            const probs = [
                { type: event.type, prob: 0.85, color: event.level },
                { type: similarEvents[0].type, prob: similarEvents[0].prob, color: 'blue' },
                { type: similarEvents[1].type, prob: similarEvents[1].prob, color: 'blue' }
            ];
            
            probs.forEach(item => {
                const percent = Math.round(item.prob * 100);
                const div = document.createElement('div');
                div.style.cssText = 'margin-bottom: 10px;';
                div.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 5px;">
                        <div style="width: 100px;">${item.type}</div>
                        <div style="flex-grow: 1; background-color: #eee; height: 20px; border-radius: 3px; overflow: hidden;">
                            <div style="width: ${percent}%; height: 100%; background-color: ${getColorCode(item.color)}; text-align: right; padding-right: 5px; color: white;">${percent}%</div>
                        </div>
                    </div>
                `;
                probContainer.appendChild(div);
            });
            
            // 根据当前激活的页面选择不同的视频源
            const video = document.getElementById('modal-monitoring-video');
            if (video) {
                const videoSource = video.querySelector('source');
                if (videoSource) {
                    // 检查当前激活的页面
                    const isHistoryPageActive = document.getElementById('history-page').classList.contains('active');
                    
                    // 根据页面类型设置不同的视频源
                    if (isHistoryPageActive) {
                        // 历史地图页面使用test1.mp4
                        videoSource.src = 'images/test1.mp4';
                        console.log("在历史地图页面加载test1.mp4");
                    } else {
                        // 实时地图页面使用test.mp4
                        videoSource.src = 'images/test.mp4';
                        console.log("在实时地图页面加载test.mp4");
                    }
                }
                
                // 重新加载并播放视频
                video.load();
                video.play().catch(e => console.log('自动播放被阻止，需要用户交互')); 
            }
            
            // 显示模态窗口
            const modal = document.getElementById('event-detail-modal');
            modal.classList.add('visible');
        };
        
        // 关闭模态窗口
        document.getElementById('modal-close').addEventListener('click', function() {
            const modal = document.getElementById('event-detail-modal');
            modal.classList.remove('visible');
        });
        
        // 获取颜色代码
        function getColorCode(level) {
            const colors = {
                'red': '#ff3b30',
                'orange': '#ff9500',
                'yellow': '#ffcc00',
                'blue': '#007aff',
                'green': '#4cd964'
            };
            return colors[level] || colors.blue;
        }
        
        // 获取级别名称
        function getLevelName(level) {
            const names = {
                'red': '极敏感事件',
                'orange': '敏感事件',
                'yellow': '关注事件',
                'blue': '普通事件',
                'green': '已处理事件'
            };
            return names[level] || level;
        }
        
        // 在全局范围内暴露这些函数
        window.getLevelName = getLevelName;
        window.getColorCode = getColorCode;
    });
    </script>

    <!-- JavaScript 引入 -->
    <script src="js/mock-data.js"></script>
    <script src="js/map.js"></script>
    <script src="js/history.js"></script>
    <script src="js/report.js"></script>
    <script src="js/main.js"></script>
    <script src="js/monitoring.js"></script>

    <!-- 内联 History Map 脚本 -->
    <script>
        console.log("[History Script] Initializing...");
        // --- 全局状态 ---
        let historyMapInstance = null;
        let historyMarkersList = [];
        let historyDistrictPolygons = [];
        let currentSelectedHistoryDate = "2025-05-04"; // 默认日期

        // --- DOM 元素引用 ---
        let historyMapContainer = null;
        let historySummaryPanel = null;
        let historySafetyPanel = null;
        // 注意：日历元素在 DOMContentLoaded 后获取

        // --- 核心功能 ---
        function initOrResizeHistoryMap() {
            console.log("[History Script] initOrResizeHistoryMap called.");
            const historyPageElement = document.getElementById('history-page');
            if (!historyPageElement || !historyPageElement.classList.contains('active')) {
                console.log("[History Script] History page not active.");
                return;
            }
            if (!historyMapContainer) {
                 historyMapContainer = document.getElementById('history-map-container');
                 if (!historyMapContainer) { console.error("Map container not found!"); return; }
            }
            try {
                if (historyMapInstance) {
                    console.log("[History Script] Resizing existing history map.");
                    historyMapInstance.resize();
                    updateHistoryMapMarkers(currentSelectedHistoryDate);
                    updateHistoryPanelData(currentSelectedHistoryDate);
                } else {
                    console.log("[History Script] Creating new history map instance.");
                    historyMapInstance = new AMap.Map(historyMapContainer, {
                        resizeEnable: true, zoom: 10, center: [114.3162, 30.5981],
                        viewMode: '2D', mapStyle: 'amap://styles/grey',
                        features: ['bg', 'road', 'building']
                    });
                    historyMapInstance.on('complete', function(){
                         document.querySelector('.amap-logo')?.remove();
                         document.querySelector('.amap-copyright')?.remove();
                     });
                    addHistoryDistrictElements(currentSelectedHistoryDate);
                    updateHistoryMapMarkers(currentSelectedHistoryDate);
                    updateHistoryPanelData(currentSelectedHistoryDate);
                    console.log("[History Script] Map instance created successfully.");
                }
            } catch (error) { console.error("[History Script] Error during map init/resize:", error); alert("历史地图加载失败。"); }
        }
        function getSafetyColor(level) {
            const colors = { 1: 'rgba(76, 217, 100, 0.4)', 2: 'rgba(140, 218, 118, 0.4)', 3: 'rgba(255, 204, 0, 0.4)', 4: 'rgba(255, 149, 0, 0.4)', 5: 'rgba(255, 59, 48, 0.4)' };
            return colors[level] || colors[3];
        }
        function addHistoryDistrictElements(date) {
             console.log("[History Script] Adding district elements for date:", date);
             if (!historyMapInstance) return;
             if (historyDistrictPolygons.length > 0) { historyMapInstance.remove(historyDistrictPolygons); historyDistrictPolygons = []; }
             const safetyData = getSafetyDataForDate(date);
             AMap.plugin('AMap.DistrictSearch', function () {
                var districtSearch = new AMap.DistrictSearch({ level: 'district', subdistrict: 1, showbiz: false });
                districtSearch.search('武汉市', function (status, result) {
                    if (status === 'complete' && result.districtList && result.districtList.length > 0) {
                        const districts = result.districtList[0].districtList;
                        districts.forEach(district => {
                            const bounds = district.boundaries; const districtName = district.name; const center = district.center;
                            const districtSafetyInfo = safetyData[districtName] || { safetyLevel: 3 };
                            if (bounds) {
                                var polygon = new AMap.Polygon({ path: bounds, strokeWeight: 1, strokeColor: '#666', fillColor: getSafetyColor(districtSafetyInfo.safetyLevel), fillOpacity: 0.6, extData: { name: districtName } });
                                polygon.setMap(historyMapInstance); historyDistrictPolygons.push(polygon);
                            }
                            try {
                                const text = new AMap.Text({ text: districtName, position: center, style: { 'background-color': 'transparent', 'border': 'none', 'font-size': '14px', 'color': '#333333', 'font-weight': 'bold' }, offset: new AMap.Pixel(0, 0), zIndex: 80 });
                                text.setMap(historyMapInstance);
                            } catch (labelError) { console.error(`Error adding label ${districtName}:`, labelError); }
                        });
                         historyMapInstance.setFitView(historyDistrictPolygons);
                         console.log("[History Script] District elements added.");
                    } else { console.error("District search failed:", status, result); }
                });
             });
         }
        function getHistoryEventsForDate(date) {
             if (date === "2025-05-04") return [ { id: 101, position: [114.288572, 30.564355], type: "火警警报", level: "orange", description:"检测到建筑火警报警器声音..." }, { id: 102, position: [114.308572, 30.594355], type: "汽车报警器", level: "yellow", description:"检测到汽车防盗报警器声音..." }, { id: 103, position: [114.328572, 30.574355], type: "狗叫", level: "blue", description:"检测到持续狗叫声..." }, { id: 104, position: [114.268572, 30.564355], type: "引擎声", level: "blue", description:"检测到大型车辆引擎声..." }, { id: 105, position: [114.348572, 30.534355], type: "警笛声", level: "yellow", description:"检测到警车警笛声..." }, { id: 106, position: [114.298572, 30.604355], type: "尖叫", level: "yellow", description:"检测到人群尖叫声..." }, { id: 107, position: [114.278572, 30.544355], type: "汽车喇叭", level: "blue", description:"检测到密集汽车喇叭声..." }, { id: 108, position: [114.36, 30.61], type: "人群聚集", level: "orange", description:"广场人群聚集..." }, { id: 109, position: [114.24, 30.58], type: "哭泣声", level: "yellow", description:"公园检测到哭泣声..." }, { id: 110, position: [114.31, 30.53], type: "撞击声", level: "red", description:"检测到剧烈撞击声..." }, { id: 111, position: [114.40, 30.56], type: "普通人声", level: "blue", description:"街道正常人声..." }, { id: 112, position: [114.18, 30.63], type: "机械声", level: "blue", description:"工地机械作业声..." }, { id: 113, position: [114.33, 30.64], type: "烟雾报警器", level: "orange", description:"小区烟雾报警..." } ];
             if (date === "2025-05-03") return [ { id: 201, position: [114.318572, 30.584355], type: "爆炸声音", level: "red", description:"检测到疑似爆炸声音..." }, { id: 202, position: [114.278572, 30.564355], type: "烟雾报警器", level: "orange", description:"检测到烟雾报警器声音..." }, { id: 203, position: [114.338572, 30.554355], type: "枪声", level: "red", description:"检测到疑似枪声..." }, { id: 204, position: [114.288572, 30.544355], type: "哭泣", level: "yellow", description:"检测到持续哭泣声..." }, { id: 205, position: [114.318572, 30.564355], type: "人群噪音", level: "orange", description:"检测到大量人群聚集噪音..." }, { id: 206, position: [114.298572, 30.574355], type: "机械声", level: "blue", description:"检测到建筑机械作业声音..." }, { id: 207, position: [114.308572, 30.544355], type: "动力锯声", level: "blue", description:"检测到动力锯切割声音..." }, { id: 208, position: [114.328572, 30.584355], type: "普通人声", level: "blue", description:"检测到正常人群交谈声..." }, { id: 209, position: [114.39, 30.59], type: "火警警报", level: "orange", description:"大楼火警警报..." }, { id: 210, position: [114.22, 30.52], type: "汽车报警器", level: "yellow", description:"停车场汽车报警..." }, { id: 211, position: [114.25, 30.62], type: "警笛声", level: "yellow", description:"街道警笛声..." }, { id: 212, position: [114.37, 30.51], type: "狗叫", level: "blue", description:"小区狗叫声..." }, { id: 213, position: [114.19, 30.55], type: "尖叫", level: "yellow", description:"小巷传来尖叫声..." }, { id: 214, position: [114.35, 30.60], type: "玻璃破碎", level: "orange", description:"检测到玻璃破碎声..." } ];
             return [];
        }
        function updateHistoryMapMarkers(date) {
            console.log(`[History Script] Updating markers for date: ${date}`);
            if (!historyMapInstance) { console.error("Map not ready for markers."); return; }
            try {
                if (historyMarkersList.length > 0) { historyMapInstance.remove(historyMarkersList); historyMarkersList = []; }
                let events = getHistoryEventsForDate(date);
                if (events.length === 0) { console.log("No events for this date."); return; }
                const colorMap = {'red':'#ff3b30', 'orange':'#ff9500', 'yellow':'#ffcc00', 'blue':'#007aff', 'green':'#4cd964'};
                const zIndexMap = {'red':110, 'orange':105, 'yellow':100, 'blue':95, 'green':90};
                events.forEach(event => {
                    if (!Array.isArray(event.position) || event.position.length !== 2) { console.warn("Invalid position:", event); return; }
                    const color = colorMap[event.level] || colorMap.blue;
                    const dotContent = `<div style="width:16px;height:16px;background-color:${color};border-radius:50%;box-shadow:0 0 5px rgba(0,0,0,0.3);"></div>`;
                    const marker = new AMap.Marker({ position: new AMap.LngLat(event.position[0], event.position[1]), content: dotContent, offset: new AMap.Pixel(-8, -8), zIndex: zIndexMap[event.level] || 90, extData: event });
                    marker.on('click', function() { if (typeof window.showEventModal === 'function') { window.showEventModal(marker.getExtData()); } else { console.error("showEventModal is not defined"); alert(`事件: ${event.type}`);} });
                    historyMarkersList.push(marker);
                });
                if (historyMarkersList.length > 0) { historyMapInstance.add(historyMarkersList); console.log(`Markers updated: ${historyMarkersList.length}`); }
            } catch (markerError) { console.error("Error updating markers:", markerError); }
        }
        function getSafetyDataForDate(date) {
             if (date === "2025-05-04") return { '江岸区': { safetyLevel: 3 }, '江汉区': { safetyLevel: 2 }, '硚口区': { safetyLevel: 2 }, '汉阳区': { safetyLevel: 1 }, '武昌区': { safetyLevel: 3 }, '青山区': { safetyLevel: 4 }, '洪山区': { safetyLevel: 5 }, '东西湖区': { safetyLevel: 3 }, '蔡甸区': { safetyLevel: 2 }, '江夏区': { safetyLevel: 4 }, '黄陂区': { safetyLevel: 2 }, '新洲区': { safetyLevel: 3 }, '汉南区': { safetyLevel: 1 } };
             if (date === "2025-05-03") return { '江岸区': { safetyLevel: 4 }, '江汉区': { safetyLevel: 3 }, '硚口区': { safetyLevel: 2 }, '汉阳区': { safetyLevel: 3 }, '武昌区': { safetyLevel: 5 }, '青山区': { safetyLevel: 5 }, '洪山区': { safetyLevel: 4 }, '东西湖区': { safetyLevel: 2 }, '蔡甸区': { safetyLevel: 1 }, '江夏区': { safetyLevel: 3 }, '黄陂区': { safetyLevel: 2 }, '新洲区': { safetyLevel: 2 }, '汉南区': { safetyLevel: 1 } };
             return {'江岸区':{safetyLevel:1},'江汉区':{safetyLevel:1},'硚口区':{safetyLevel:1},'汉阳区':{safetyLevel:1},'武昌区':{safetyLevel:1},'青山区':{safetyLevel:1},'洪山区':{safetyLevel:1},'东西湖区':{safetyLevel:1},'蔡甸区':{safetyLevel:1},'江夏区':{safetyLevel:1},'黄陂区':{safetyLevel:1},'新洲区':{safetyLevel:1},'汉南区':{safetyLevel:1}};
        }

        // **修改：更新面板数据 - 使用更大的模拟事件数量**
        function updateHistoryPanelData(date) {
            console.log(`[History Script] Updating panels for date: ${date}`);
            try {
                let eventCounts = {};
                let safetyData = getSafetyDataForDate(date); // 安全数据不变

                // **直接设置更大的模拟数量，而不是从 getHistoryEventsForDate 计算**
                if (date === "2025-05-04") {
                    // 总数 = 15 + 28 + 45 + 75 = 163
                    eventCounts = { 'red': 15, 'orange': 28, 'yellow': 45, 'blue': 75, 'green': 12 }; // 添加已处理
                } else if (date === "2025-05-03") {
                    // 总数 = 22 + 35 + 38 + 65 = 160
                    eventCounts = { 'red': 22, 'orange': 35, 'yellow': 38, 'blue': 65, 'green': 8 }; // 添加已处理
                } else {
                    eventCounts = {'red':0,'orange':0,'yellow':0,'blue':0,'green':0};
                }

                // 更新事件统计面板 (卡片布局)
                if (historySummaryPanel) {
                    const typeNames = { 'red': '极敏感', 'orange': '敏感', 'yellow': '关注', 'blue': '普通', 'green': '已处理' };
                    const colorMap = { 'red': '#ff3b30', 'orange': '#ff9500', 'yellow': '#ffcc00', 'blue': '#007aff', 'green': '#4cd964' };
                    let summaryHtml = '<div class="history-summary-cards">';
                    ['red', 'orange', 'yellow', 'blue', 'green'].forEach(level => {
                        const count = eventCounts[level] || 0;
                        summaryHtml += `
                            <div class="summary-card level-${level}" style="border-top-color: ${colorMap[level]};">
                                <div class="summary-card-count" style="color: ${colorMap[level]};">${count}</div>
                                <div class="summary-card-label">${typeNames[level]}</div>
                            </div>`;
                    });
                    summaryHtml += '</div>';
                    historySummaryPanel.innerHTML = summaryHtml;
                    console.log("[History Script] Summary panel updated with larger counts.");
                } else { console.error("[History Script] Summary panel element not found!"); }

                // 更新安全指数面板 (两列布局)
                if (historySafetyPanel) {
                    const safetyTexts = ['', '安全', '较安全', '一般', '需注意', '危险'];
                    const solidBgColors = ['', '#e8f5e9', '#fff9c4', '#fff3e0', '#ffebee', '#fce4ec'];
                    const borderColors = ['', '#4caf50', '#8bc34a', '#ffeb3b', '#ff9800', '#f44336'];
                    const sortedDistricts = Object.keys(safetyData).sort((a, b) => safetyData[a].safetyLevel - safetyData[b].safetyLevel);
                    let safetyItemsHtml = '';
                    sortedDistricts.forEach(district => {
                         const level = safetyData[district].safetyLevel;
                         safetyItemsHtml += `<div class="safety-item level-${level}" style="background-color:${solidBgColors[level]}; border-left-color:${borderColors[level]}"><span class="safety-district-name">${district}</span><span class="safety-value">${safetyTexts[level]}</span></div>`;
                    });
                    historySafetyPanel.innerHTML = `<div class="safety-grid">${safetyItemsHtml}</div>`;
                    console.log("[History Script] Safety panel updated.");
                } else { console.error("[History Script] Safety panel element not found!"); }

                // 更新地图区域颜色 (逻辑不变)
                if (historyDistrictPolygons.length > 0) {
                     historyDistrictPolygons.forEach(polygon => {
                         const name = polygon.getExtData().name;
                         const level = safetyData[name]?.safetyLevel || 3;
                         polygon.setOptions({ fillColor: getSafetyColor(level) });
                     });
                     console.log("Map district colors updated.");
                 }

            } catch (panelError) {
                console.error("[History Script] Error updating panels:", panelError);
            }
        }

        // 日期切换处理 (逻辑不变)
        function handleDateClick(event) {
            const targetDay = event.currentTarget;
            if (!targetDay || !targetDay.classList.contains('day-selectable')) { return; }
            const date = targetDay.getAttribute('data-date');
            if (!date || (date !== "2025-05-03" && date !== "2025-05-04")) { console.warn("Invalid date selected:", date); return; }
            console.log(`[History Script] Date ${date} clicked.`);
            currentSelectedHistoryDate = date;
            try {
                const allSelectableDays = document.querySelectorAll('.calendar-day.day-selectable');
                if(allSelectableDays) { allSelectableDays.forEach(day => { day.classList.remove('active'); }); targetDay.classList.add('active'); console.log("Calendar UI updated."); }
                else { console.error("Selectable calendar days not found."); }
            } catch (uiError) { console.error("Error updating calendar UI:", uiError); }
            if (historyMapInstance) { console.log("Updating map/panels..."); updateHistoryMapMarkers(date); updateHistoryPanelData(date); }
            else { console.warn("Map not ready."); }
        }

        // 初始化流程 (逻辑不变)
        document.addEventListener('DOMContentLoaded', function() {
            console.log("[History Script] DOMContentLoaded.");
            historyMapContainer = document.getElementById('history-map-container');
            historySummaryPanel = document.getElementById('history-summary');
            historySafetyPanel = document.getElementById('history-safety-index');
            const calendarDays = document.querySelectorAll('.calendar-day');
            if (!historyMapContainer || !historySummaryPanel || !historySafetyPanel || !calendarDays || calendarDays.length === 0) { console.error("Essential history elements missing!"); }
             calendarDays.forEach(day => { if (day.classList.contains('day-selectable')) { day.addEventListener('click', handleDateClick); console.log(`Listener added for ${day.getAttribute('data-date')}`); } else if (day.classList.contains('day-looks-selectable')) { day.addEventListener('click', () => console.log("Clicked a non-functional date.")); } });
            document.querySelectorAll('.nav-link').forEach(link => { link.addEventListener('click', function(e) { e.preventDefault(); const pageId = this.getAttribute('data-page') + '-page'; document.querySelectorAll('.page').forEach(p => p.classList.remove('active')); document.getElementById(pageId)?.classList.add('active'); document.querySelectorAll('.nav-link').forEach(nav => nav.classList.remove('active')); this.classList.add('active'); if (pageId === 'history-page') { console.log("Navigated to History. Scheduling init/resize."); setTimeout(initOrResizeHistoryMap, 300); } }); });
            if (document.getElementById('history-page')?.classList.contains('active')) { console.log("History active on load. Scheduling init."); setTimeout(initOrResizeHistoryMap, 300); }
            console.log("[History Script] Initial setup complete.");
        });

    </script>

    <!-- CSS -->
    <style>
        /* ... (保留卡片布局和安全指数样式) ... */
        .history-summary-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 10px; }
        .summary-card { background-color: #f9f9f9; border-radius: 6px; padding: 15px; text-align: center; border-top: 4px solid #ccc; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .summary-card-count { font-size: 24px; font-weight: bold; margin-bottom: 5px; }
        .summary-card-label { font-size: 13px; color: #555; }

        #history-safety-index .safety-grid { display: flex; flex-wrap: wrap; gap: 10px; }
        #history-safety-index .safety-item { width: calc(50% - 5px); box-sizing: border-box; display: flex; justify-content: space-between; align-items: center; padding: 10px 12px; margin-bottom: 0; border-radius: 4px; font-size: 14px; cursor: pointer; border-left-width: 4px; border-left-style: solid; color: #333; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        #history-safety-index .safety-value { font-weight: bold; white-space: nowrap; margin-left: 5px; }
        #history-safety-index .level-1 { background-color: #e8f5e9; border-left-color: #4caf50; }
        #history-safety-index .level-2 { background-color: #f1f8e9; border-left-color: #8bc34a; }
        #history-safety-index .level-3 { background-color: #fffde7; border-left-color: #ffeb3b; }
        #history-safety-index .level-4 { background-color: #fff3e0; border-left-color: #ff9800; }
        #history-safety-index .level-5 { background-color: #ffebee; border-left-color: #f44336; }

        /* --- 修改日历样式 --- */
        .calendar-day { text-align: center; padding: 8px 0; border-radius: 4px; font-size: 14px; }
        .day-header { font-weight: bold; color: #666; }
        /* 让 '看起来可选' 的日期样式与 '可选' 日期一致 */
        .calendar-day.day-looks-selectable,
        .calendar-day.day-selectable {
            background-color: #e3f2fd; /* 浅蓝色背景 */
            color: #1e88e5;          /* 蓝色文字 */
            cursor: pointer;         /* 手型光标 */
            transition: background-color 0.2s;
        }
        /* 鼠标悬停效果 - 仅对可选日期和看起来可选日期生效 */
        .calendar-day.day-looks-selectable:hover,
        .calendar-day.day-selectable:hover {
            background-color: #bbdefb; /* 悬停时加深背景色 */
        }
        /* 激活状态 - 仅对可选日期生效 */
        .calendar-day.day-selectable.active {
            background-color:#0d47a1; /* 深蓝色背景 */
            color:white;              /* 白色文字 */
            font-weight:bold;
        }
        /* 禁用状态 */
        .calendar-day.day-disabled {
            color: #ccc;
            background-color: #f9f9f9;
            cursor: not-allowed;
        }
        /* 移除之前的 .day-other-month 样式，因为它被 day-looks-selectable 覆盖 */
        /* .calendar-day.day-other-month { background-color: #f5f5f5; color: #aaa; cursor: default; } */
    </style>
    <!-- ... (</body> 和 </html>) ... -->
</body>
</html>